# ============================================================
# PostgreSQL Configuration for Scraper-Pro Production
# ============================================================
# Optimized for: Hetzner CPX31 (4 vCPU, 8GB RAM)
# PostgreSQL Version: 16
# ============================================================

# ────────────────────────────────────────────────────────────
# CONNECTION SETTINGS
# ────────────────────────────────────────────────────────────

# Maximum connections (default: 100)
# Set lower to reserve memory for scraping workload
max_connections = 50

# Superuser reserved connections
superuser_reserved_connections = 3

# ────────────────────────────────────────────────────────────
# MEMORY SETTINGS (Tuned for 8GB RAM)
# ────────────────────────────────────────────────────────────

# Shared buffers: 25% of total RAM (2GB)
# Used for caching data in memory
shared_buffers = 2GB

# Effective cache size: 75% of total RAM (6GB)
# Tells planner how much memory is available for caching
effective_cache_size = 6GB

# Work memory: Per-operation memory for sorting/hashing
# 64MB allows complex queries without spilling to disk
work_mem = 64MB

# Maintenance work memory: For VACUUM, CREATE INDEX, etc.
# 512MB speeds up maintenance operations
maintenance_work_mem = 512MB

# Huge pages: Try to use huge pages (requires OS config)
huge_pages = try

# ────────────────────────────────────────────────────────────
# WRITE AHEAD LOG (WAL) - Durability vs Performance
# ────────────────────────────────────────────────────────────

# WAL level: replica (for streaming replication if needed)
wal_level = replica

# Checkpoint settings: Balance durability vs performance
# Larger checkpoint_timeout reduces checkpoint frequency
checkpoint_timeout = 15min
checkpoint_completion_target = 0.9

# WAL buffers: Auto-tuned (typically 16MB for 2GB shared_buffers)
wal_buffers = -1

# Maximum WAL size: 2GB allows longer checkpoint intervals
max_wal_size = 2GB
min_wal_size = 512MB

# ────────────────────────────────────────────────────────────
# QUERY TUNING
# ────────────────────────────────────────────────────────────

# Enable parallel queries (4 vCPU)
max_parallel_workers_per_gather = 2
max_parallel_workers = 4
max_worker_processes = 4

# Random page cost: Lower for SSD (default: 4.0)
random_page_cost = 1.1

# Effective IO concurrency: SSD can handle more simultaneous requests
effective_io_concurrency = 200

# ────────────────────────────────────────────────────────────
# LOGGING
# ────────────────────────────────────────────────────────────

# Log slow queries (> 1000ms)
log_min_duration_statement = 1000

# Log checkpoints (useful for tuning)
log_checkpoints = on

# Log connections/disconnections
log_connections = off
log_disconnections = off

# Log line prefix: timestamp, user, database, pid
log_line_prefix = '%t [%u@%d] [%p] '

# Log destination: stderr (captured by Docker)
log_destination = 'stderr'

# Logging collector: off (Docker handles logs)
logging_collector = off

# ────────────────────────────────────────────────────────────
# AUTOVACUUM (Automatic Cleanup)
# ────────────────────────────────────────────────────────────

# Enable autovacuum (essential for performance)
autovacuum = on

# Autovacuum max workers: 3 (balance cleanup vs CPU)
autovacuum_max_workers = 3

# Autovacuum naptime: 1 minute (more aggressive cleanup)
autovacuum_naptime = 1min

# Vacuum cost delay: 2ms (balance IO vs responsiveness)
autovacuum_vacuum_cost_delay = 2ms

# Vacuum cost limit: 500 (higher = faster cleanup)
autovacuum_vacuum_cost_limit = 500

# ────────────────────────────────────────────────────────────
# STATISTICS
# ────────────────────────────────────────────────────────────

# Track query statistics
shared_preload_libraries = 'pg_stat_statements'

# Track all statements (for performance analysis)
pg_stat_statements.track = all
pg_stat_statements.max = 10000

# ────────────────────────────────────────────────────────────
# CLIENT CONNECTION DEFAULTS
# ────────────────────────────────────────────────────────────

# Timezone: UTC (consistent with application)
timezone = 'UTC'

# Locale: C (fastest, no locale-specific sorting)
lc_messages = 'C'
lc_monetary = 'C'
lc_numeric = 'C'
lc_time = 'C'

# Default text search config
default_text_search_config = 'pg_catalog.english'

# ────────────────────────────────────────────────────────────
# PERFORMANCE NOTES
# ────────────────────────────────────────────────────────────
#
# Expected Performance:
# - Simple SELECT: < 1ms
# - Complex JOIN: 10-50ms
# - INSERT/UPDATE: 1-5ms
# - VACUUM: Background, minimal impact
#
# Monitoring:
# - Check pg_stat_statements for slow queries
# - Monitor checkpoint frequency (aim for 15min intervals)
# - Watch autovacuum activity (should run regularly)
#
# Tuning Commands:
# - Show config: SHOW ALL;
# - Show slow queries: SELECT * FROM pg_stat_statements ORDER BY total_exec_time DESC LIMIT 10;
# - Show table sizes: SELECT schemaname, tablename, pg_size_pretty(pg_total_relation_size(schemaname||'.'||tablename)) FROM pg_tables ORDER BY pg_total_relation_size(schemaname||'.'||tablename) DESC;
# ============================================================
